// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String   @id @default(uuid())
  walletAddress         String   @unique
  smartAccountAddress   String?
  email                 String?
  notificationPreferences Json?  @default("{\"browser\": true, \"email\": false}")
  totalSavedUsd         Decimal  @default(0) @db.Decimal(10, 2)
  transactionCount      Int      @default(0)
  optimalExecutionRate  Decimal  @default(0) @db.Decimal(5, 2)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  lastActiveAt          DateTime?

  transactions          Transaction[]
  alerts                Alert[]
  notifications         Notification[]
  conversations         Conversation[]

  @@index([walletAddress])
  @@index([totalSavedUsd(sort: Desc)])
}

model Transaction {
  id                    String   @id @default(uuid())
  executionId           String   @unique
  userId                String
  status                String   // SCHEDULED, MONITORING, COMPLETED, FAILED, REFUNDED
  transactionType       String?

  // Safety Parameters
  maxGasPrice           BigInt
  minAssetPrice         BigInt?
  maxSlippage           Int?
  deadline              DateTime

  // Transaction Details
  targetAddress         String
  transactionData       String
  value                 String   @default("0")

  // Execution Results
  actualGasPrice        BigInt?
  actualFlrPrice        BigInt?
  gasUsed               BigInt?
  txHash                String?
  blockNumber           BigInt?

  // Savings Calculation
  immediateCostUsd      Decimal? @db.Decimal(10, 4)
  actualCostUsd         Decimal? @db.Decimal(10, 4)
  savedUsd              Decimal? @db.Decimal(10, 4)
  savingsPercentage     Decimal? @db.Decimal(5, 2)

  // Timestamps
  scheduledAt           DateTime @default(now())
  executedAt            DateTime?
  completedAt           DateTime?

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([deadline])
}

model Alert {
  id                    String   @id @default(uuid())
  userId                String
  alertType             String
  condition             Json
  notificationChannels  Json     @default("{\"browser\": true}")
  status                String   @default("ACTIVE") // ACTIVE, DELETED
  lastTriggeredAt       DateTime?
  triggerCount          Int      @default(0)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  triggers              AlertTrigger[]

  @@index([userId])
  @@index([status])
}

model AlertTrigger {
  id                    String   @id @default(uuid())
  alertId               String
  triggeredAt           DateTime @default(now())

  alert                 Alert    @relation(fields: [alertId], references: [id], onDelete: Cascade)

  @@index([alertId])
  @@index([triggeredAt])
}

model GasHistory {
  id                    String   @id @default(uuid())
  gasPrice              Decimal  @db.Decimal(10, 2)
  timestamp             DateTime @default(now())

  @@index([timestamp])
}

model Leaderboard {
  id                    String   @id @default(uuid())
  userId                String   @unique
  rank                  Int
  totalSaved            Decimal  @db.Decimal(10, 2)
  transactionCount      Int
  updatedAt             DateTime @updatedAt

  @@index([rank])
  @@index([totalSaved(sort: Desc)])
}

model Savings {
  id                    String   @id @default(uuid())
  userId                String
  transactionId         String?
  amount                Decimal  @db.Decimal(10, 4)
  currency              String   @default("USD")
  createdAt             DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Conversation {
  id                    String   @id @default(uuid())
  userId                String
  messages              Json
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Notification {
  id                    String   @id @default(uuid())
  userId                String
  type                  String   // ALERT, TRANSACTION, SYSTEM
  message               String
  read                  Boolean  @default(false)
  createdAt             DateTime @default(now())

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model ModelMetadata {
  id                    String   @id
  modelType             String
  lastTrained           DateTime
  version               String
  accuracy              Decimal? @db.Decimal(5, 4)
  metadata              Json?
}

